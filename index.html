<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Agent Brainstorming System (Client-Side)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .agent-card {
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        .stage-title {
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .loader {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Prose styles for rendered markdown */
        .prose h1,
        .prose h2,
        .prose h3 {
            font-weight: 600;
        }

        .prose ul {
            list-style-type: disc;
            margin-left: 1.5rem;
        }

        .prose table {
            width: 100%;
            border-collapse: collapse;
        }

        .prose th,
        .prose td {
            border: 1px solid #d1d5db;
            padding: 0.5rem 1rem;
        }

        .prose th {
            background-color: #f9fafb;
        }

        .prose pre {
            background-color: #f3f4f6;
            padding: 1rem;
            border-radius: 0.5rem;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Styles for Mermaid Chart and Controls */
        #chart-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            align-items: center;
        }

        #chart-container {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 1rem;
            background-color: #f9fafb;
            overflow: auto;
            /* Make it scrollable if content overflows */
            max-height: 40vh;
            /* Limit height to roughly 1/3 of viewport */
            resize: vertical;
            /* Allow user to resize vertically */
        }

        #chart-container .mermaid {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100%;
        }

        #chart-container .mermaid svg {
            max-width: none;
            /* Allow SVG to exceed container for zooming */
            height: auto;
            transition: transform 0.2s ease-in-out;
        }

        /* Fullscreen Modal Styles */
        #fullscreen-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            /* display: flex; /* REMOVED to prevent override */
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 2rem;
            box-sizing: border-box;
        }

        #fullscreen-modal-content {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #close-fullscreen {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 2.5rem;
            color: white;
            cursor: pointer;
            line-height: 1;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Multi-Agent Brainstorming System</h1>
            <p class="mt-2 text-lg text-gray-600">A Client-Side AI Agent System Running in Your Browser</p>
            <p class="text-sm text-gray-600 mt-1">By Yuxiang | <a href="mailto:yuxiang.lin@gatech.edu"
                    class="text-blue-500 hover:underline">yuxiang.lin@gatech.edu</a></p>
            <p class="text-xs text-gray-500 mt-1">Feel free to contact for any advice.</p>
        </header>

        <div id="settings-container" class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-8 rounded-r-lg">
            <h2 class="text-xl font-semibold text-gray-800">Settings</h2>
            <p class="text-gray-700 mt-2 mb-4">Please enter your Google Gemini API Key to use this application. Your key
                is secure and never leaves your browser.</p>
            <p class="text-gray-700 mt-2 mb-4">You can get your free API Key from <a
                    href="https://aistudio.google.com/apikey" target="_blank"
                    class="text-yellow-600 font-semibold hover:underline">Google AI Studio</a>.</p>
            <div class="flex flex-col sm:flex-row gap-2">
                <input type="password" id="api-key-input" placeholder="Enter your Google API Key"
                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:outline-none transition">
                <button id="save-key-btn"
                    class="bg-yellow-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-yellow-600 transition-all duration-200">Save
                    Key</button>
            </div>
            <p id="key-status" class="text-sm mt-2 text-green-700 font-semibold hidden">API Key has been set for this
                session.</p>
        </div>

        <div id="stage-1-container" class="bg-white p-6 rounded-xl shadow-md mb-8">
            <h2 class="text-xl font-semibold text-gray-700 stage-title">Stage 1: Define Direction & Assemble Team</h2>
            <form id="brainstorm-form">
                <div class="mb-4">
                    <label for="brainstorm-type" class="block text-gray-700 font-semibold mb-2">Select Brainstorm
                        Type:</label>
                    <select id="brainstorm-type"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                        <option value="project">Project Idea (for products, features, etc.)</option>
                        <option value="research_paper">Research Paper (for academic topics, studies, etc.)</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="topic-input" class="block text-gray-700 font-semibold mb-2">Enter Topic:</label>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <input type="text" id="topic-input"
                            placeholder="e.g., 'Using LLM for the course project of HCI.'"
                            class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                        <button type="submit" id="start-btn"
                            class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 transition-all duration-200 flex items-center justify-center"
                            disabled>
                            <span id="start-btn-text">Start Brainstorm</span>
                        </button>
                    </div>
                </div>
            </form>
            <div id="preview-agent-loader" class="hidden flex-col items-center mt-6">
                <div class="loader"></div>
                <p class="mt-2 text-gray-600">Preview Agent is assembling the expert team...</p>
            </div>
            <div id="persona-container" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>

        <div id="stage-rag-container" class="hidden bg-white p-6 rounded-xl shadow-md mb-8">
            <h2 class="text-xl font-semibold text-gray-700 stage-title">Context via RAG Agent</h2>
            <p class="text-gray-600 mb-4">A Research Agent is now performing a live web search on the topic to provide
                real-time context for the brainstorming agents.</p>
            <div id="rag-loader" class="flex flex-col items-center mt-6">
                <div class="loader"></div>
                <p id="rag-loader-text" class="mt-2 text-gray-600">Research Agent is performing a web search...</p>
            </div>
            <div id="rag-summary-container" class="prose max-w-none mt-6 bg-gray-50 p-4 rounded-lg"></div>
        </div>

        <div id="stage-2-container" class="hidden bg-white p-6 rounded-xl shadow-md mb-8">
            <h2 class="text-xl font-semibold text-gray-700 stage-title">Stage 2: Divergent Ideation & Filtering</h2>
            <p class="text-gray-600 mb-4">The agents are generating ideas. Once complete, please review and uncheck any
                ideas you wish to exclude from the final evaluation.</p>
            <div id="divergent-loader" class="flex flex-col items-center mt-6">
                <div class="loader"></div>
                <p class="mt-2 text-gray-600">Ideation in progress... agents are brainstorming...</p>
            </div>
            <div id="ideas-container" class="mt-6 grid grid-cols-1 gap-6"></div>
            <div class="text-center mt-8">
                <button id="to-convergent-btn"
                    class="hidden bg-green-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-700 transition-all duration-200">
                    Proceed to Evaluation with Selected Ideas
                </button>
            </div>
        </div>

        <div id="stage-3-container" class="hidden bg-white p-6 rounded-xl shadow-md mb-8">
            <h2 class="text-xl font-semibold text-gray-700 stage-title">Stage 3 & 4: Convergent Evaluation</h2>
            <p class="text-gray-600 mb-4">A Critic Agent will now analyze, cluster, and evaluate the ideas you selected
                to identify the most promising concepts.</p>
            <div id="convergent-loader" class="flex flex-col items-center mt-6">
                <div class="loader"></div>
                <p class="mt-2 text-gray-600">Critic agent is analyzing and ranking ideas...</p>
            </div>
            <div id="evaluation-container" class="prose max-w-none mt-6"></div>
            <div id="top-ideas-container" class="mt-8"></div>
        </div>

        <div id="stage-5-container" class="hidden bg-white p-6 rounded-xl shadow-md mb-8">
            <h2 class="text-xl font-semibold text-gray-700 stage-title">Stage 5: Final Document Generation</h2>
            <p id="stage-5-subtitle" class="text-gray-600 mb-4">An expert agent is generating the final document for the
                selected idea.</p>
            <div id="planning-loader" class="flex flex-col items-center mt-6">
                <div class="loader"></div>
                <p class="mt-2 text-gray-600">Expert agent is drafting the document and flowchart...</p>
            </div>
            <div id="planning-container" class="prose max-w-none mt-6"></div>
        </div>
    </div>

    <!-- Fullscreen Modal for Chart -->
    <div id="fullscreen-modal" class="hidden">
        <span id="close-fullscreen">&times;</span>
        <div id="fullscreen-modal-content">
            <!-- Fullscreen SVG will be injected here -->
        </div>
    </div>


    <script type="module">
        // --- CONFIGURATION & STATE ---
        let userApiKey = null;
        let brainstormType = 'project';
        let allParsedIdeas = []; // Holds { role, idea, id } for filtering
        let chartZoomLevel = 1.0;
        mermaid.initialize({ startOnLoad: false, theme: 'neutral' });

        // --- PROMPT TEMPLATES ---
        const prompts = {
            persona: {
                project: `You are a world-class innovation consultant. The user wants to brainstorm project ideas for '{topic}'. Your task is to identify and define 4 distinct, expert personas (e.g., Product Manager, Lead Engineer, Marketing Head, User Advocate). For each, provide their Role, Goal, and Backstory.\n\nUse this context: {rag_summary}`,
                research_paper: `You are a distinguished academic advisor. The user wants to brainstorm research paper ideas for '{topic}'. Your task is to identify and define 4 distinct scholarly personas (e.g., Lead Researcher, Literature Review Specialist, Methodology Expert). For each, provide their Role, Goal, and Backstory.\n\nUse this context: {rag_summary}`
            },
            rag_summary: `You are a Research Analyst. Your task is to provide a concise, neutral summary of the following text to be used as context for a brainstorming session. Focus on key concepts, definitions, and the current state of the topic.\nSearch Results:\n---\n{search_results}\n---\n\nProvide your summary in a single, dense paragraph.`,
            ideation: {
                project: `Your Persona:\n- Role: {role}\n- Backstory: {backstory}\n- Goal: {goal}\n\nBased on your unique persona, brainstorm 5 innovative project ideas or features about '{topic}'. Use this context: {rag_summary}\n\nYour primary goal is quantity and novelty. Do NOT critique your own ideas. Present your ideas as a simple bulleted list in Markdown.`,
                research_paper: `Your Persona:\n- Role: {role}\n- Backstory: {backstory}\n- Goal: {goal}\n\nBased on your unique scholarly persona, brainstorm 5 innovative research questions, hypotheses, or study designs related to '{topic}'. Use this context: {rag_summary}\n\nYour primary goal is novelty and potential for scholarly contribution. Do NOT critique your ideas yet. Present your ideas as a simple bulleted list in Markdown.`
            },
            evaluation: {
                project: `You are a Chief Analyst at a venture capital firm. You have received a list of raw, brainstormed project ideas. Your task is to perform a convergent analysis.\n\n1. **Synthesize & Cluster:** Read all the ideas. De-duplicate them and group similar concepts into project themes.\n2. **Critique & Evaluate:** For each unique project theme, provide a critical evaluation in a markdown table with columns: 'Project Theme', 'Description', 'Novelty (1-10)', 'Feasibility (1-10)', 'Impact (1-10)', 'Justification'.\n3. **Select Top 3:** After the table, explicitly state 'Here are the top 3 project ideas:'. Then, provide a JSON array of objects for the top 3 projects you recommend. Each object needs 'title' and 'description' keys. This JSON array must be at the very end in a \`\`\`json code block.\n\nRaw Ideas:\n---\n{raw_ideas}\n---`,
                research_paper: `You are a seasoned peer reviewer for a top-tier academic journal. You have received a list of raw, brainstormed research ideas. Your task is to perform a convergent analysis.\n\n1. **Synthesize & Cluster:** Read all the ideas. Group similar concepts into distinct research avenues.\n2. **Critique & Evaluate:** For each research avenue, provide a critical evaluation in a markdown table with columns: 'Research Avenue', 'Description', 'Novelty/Originality (1-10)', 'Methodological Soundness (1-10)', 'Potential Contribution (1-10)', 'Justification'.\n3. **Select Top 3:** After the table, explicitly state 'Here are the top 3 research ideas:'. Then, provide a JSON array of objects for the top 3 research questions you recommend. Each object needs 'title' (a concise research question) and 'description' (a brief explanation of the study). This JSON array must be at the very end in a \`\`\`json code block.\n\nRaw Ideas:\n---\n{raw_ideas}\n---`
            },
            planning: {
                project: `You are an expert AI Project Manager. A promising idea has been selected. Generate a detailed, concise project initiation document in Markdown.\n\n**Selected Idea:**\n- **Title:** {title}\n- **Description:** {description}\n\nPlease include these sections:\n### High-Level Requirements & User Stories\n### Proposed Technology Stack\n### Phased Project Timeline (with estimated weeks)\n### Initial Resource Estimation (roles needed)\n\nFinally, create a Mermaid flowchart to visualize the project timeline. Enclose it in a \`\`\`mermaid code block. IMPORTANT: Use double quotes for the text inside nodes, like A["Your Text Here"]. For example:\n\`\`\`mermaid\ngraph TD;\n    A["Phase 1: Discovery & Research (4 weeks)"] --> B["Phase 2: Design & Prototyping (6 weeks)"];\n    B --> C["Phase 3: Development & Testing (8 weeks)"];\n    C --> D["Phase 4: Deployment & Launch (2 weeks)"];\n\`\`\`\n`,
                research_paper: `You are an experienced academic writer. A promising research idea has been selected. Generate a concise research paper outline or abstract in Markdown.\n\n**Selected Research Question:**\n- **Title:** {title}\n- **Description:** {description}\n\nPlease include these sections:\n### 1. Introduction & Problem Statement\n### 2. Preliminary Literature Review\n### 3. Proposed Methodology\n### 4. Expected Outcomes & Contribution to the Field\n### 5. Potential Target Conferences for Publication\n\nFinally, create a Mermaid flowchart to visualize the research stages. Enclose it in a \`\`\`mermaid code block. IMPORTANT: Use double quotes for the text inside nodes, like A["Your Text Here"]. For example:\n\`\`\`mermaid\ngraph TD;\n    A["Literature Review"] --> B["Formulate Hypothesis"];\n    B --> C["Design Experiment"];\n    C --> D["Collect & Analyze Data"];\n    D --> E["Write Paper"];\n\`\`\`\n`
            }
        };

        // --- DOM ELEMENT REFERENCES ---
        const apiKeyInput = document.getElementById('api-key-input');
        const saveKeyBtn = document.getElementById('save-key-btn');
        const keyStatus = document.getElementById('key-status');
        const brainstormForm = document.getElementById('brainstorm-form');
        const brainstormTypeInput = document.getElementById('brainstorm-type');
        const topicInput = document.getElementById('topic-input');
        const startBtn = document.getElementById('start-btn');
        const previewAgentLoader = document.getElementById('preview-agent-loader');
        const personaContainer = document.getElementById('persona-container');
        const stageRagContainer = document.getElementById('stage-rag-container');
        const ragLoader = document.getElementById('rag-loader');
        const ragLoaderText = document.getElementById('rag-loader-text');
        const ragSummaryContainer = document.getElementById('rag-summary-container');
        const stage2Container = document.getElementById('stage-2-container');
        const divergentLoader = document.getElementById('divergent-loader');
        const ideasContainer = document.getElementById('ideas-container');
        const toConvergentBtn = document.getElementById('to-convergent-btn');
        const stage3Container = document.getElementById('stage-3-container');
        const convergentLoader = document.getElementById('convergent-loader');
        const evaluationContainer = document.getElementById('evaluation-container');
        const topIdeasContainer = document.getElementById('top-ideas-container');
        const stage5Container = document.getElementById('stage-5-container');
        const stage5Subtitle = document.getElementById('stage-5-subtitle');
        const planningLoader = document.getElementById('planning-loader');
        const planningContainer = document.getElementById('planning-container');
        const fullscreenModal = document.getElementById('fullscreen-modal');
        const fullscreenModalContent = document.getElementById('fullscreen-modal-content');
        const closeFullscreenBtn = document.getElementById('close-fullscreen');


        // --- GEMINI API HELPER ---
        async function callGemini(contents, generationConfig = {}) {
            if (!userApiKey) {
                alert("Please set your Google API Key in the settings before proceeding.");
                throw new Error("API Key not set.");
            }
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${userApiKey}`;
            const payload = { contents, generationConfig };
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json; charset=UTF-8' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("API Error Response Body:", errorBody);
                    throw new Error(`API request failed with status ${response.status}: ${response.statusText}`);
                }
                const result = await response.json();

                if (result.error) {
                    console.error("API Error Response:", result.error);
                    throw new Error(`API returned an error: ${result.error.message}`);
                }
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content) {
                    return result;
                } else {
                    console.warn("API response missing candidates or content:", result);
                    if (result.candidates && result.candidates[0]?.finishReason === 'SAFETY') {
                        throw new Error("Content blocked by safety settings. Please try a different topic.");
                    }
                    throw new Error("Received an invalid or empty response from the Gemini API.");
                }
            } catch (error) {
                console.error("Error in callGemini function:", error);
                alert(`An error occurred while communicating with the API. Please check the console for details. Error: ${error.message}`);
                throw error;
            }
        }

        // --- UI & WORKFLOW LOGIC ---
        function showLoader(loaderElement, text = null) {
            loaderElement.classList.remove('hidden');
            loaderElement.classList.add('flex');
            if (text) {
                const textElement = loaderElement.querySelector('p');
                if (textElement) textElement.textContent = text;
            }
        }

        function hideLoader(loaderElement) {
            loaderElement.classList.add('hidden');
            loaderElement.classList.remove('flex');
        }

        function sanitizeHTML(str) {
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        }

        saveKeyBtn.addEventListener('click', () => {
            const key = apiKeyInput.value.trim();
            if (key) {
                userApiKey = key;
                keyStatus.textContent = "API Key has been set for this session.";
                keyStatus.classList.remove('hidden');
                apiKeyInput.value = '';
                apiKeyInput.type = "password";
                startBtn.disabled = false;
                setTimeout(() => keyStatus.classList.add('hidden'), 3000);
            } else {
                alert("Please enter a valid API key.");
            }
        });

        brainstormForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userApiKey) {
                alert("Please save your API key first!");
                return;
            }
            const topic = topicInput.value.trim();
            if (!topic) {
                alert('Please enter a topic to brainstorm.');
                return;
            }
            brainstormType = brainstormTypeInput.value;

            // --- Reset UI for a new run ---
            [stageRagContainer, stage2Container, stage3Container, stage5Container].forEach(el => el.classList.add('hidden'));
            [personaContainer, ragSummaryContainer, ideasContainer, evaluationContainer, topIdeasContainer, planningContainer].forEach(el => el.innerHTML = '');
            toConvergentBtn.classList.add('hidden');
            allParsedIdeas = [];
            startBtn.disabled = true;

            // This now runs the RAG search first to provide context for persona generation
            const ragSummary = await runRagAgent(topic);
            if (ragSummary && ragSummary !== "Could not generate a summary.") {
                const personas = await runPreviewAgent(topic, ragSummary);
                if (personas && personas.length > 0) {
                    await runDivergentIdeation(topic, personas, ragSummary);
                }
            }
            startBtn.disabled = false;
        });

        async function runPreviewAgent(topic, ragSummary) {
            showLoader(previewAgentLoader);
            personaContainer.innerHTML = '';
            const schema = {
                type: "OBJECT",
                properties: { personas: { type: "ARRAY", items: { type: "OBJECT", properties: { role: { "type": "STRING" }, goal: { "type": "STRING" }, backstory: { "type": "STRING" } }, required: ["role", "goal", "backstory"] } } },
                required: ["personas"]
            };
            const prompt = prompts.persona[brainstormType]
                .replace('{topic}', sanitizeHTML(topic))
                .replace('{rag_summary}', ragSummary); // Use the RAG summary
            try {
                const response = await callGemini([{ role: "user", parts: [{ text: prompt }] }], { responseMimeType: "application/json", responseSchema: schema });
                const personaData = JSON.parse(response.candidates[0].content.parts[0].text);
                hideLoader(previewAgentLoader);
                stage2Container.classList.remove('hidden'); // Show next stage directly
                personaData.personas.forEach(p => {
                    const card = document.createElement('div');
                    card.className = 'agent-card bg-white p-4 rounded-lg border';
                    card.innerHTML = `<h3 class="font-bold text-blue-600">${sanitizeHTML(p.role)}</h3><p class="text-sm text-gray-500 mt-1"><strong>Goal:</strong> ${sanitizeHTML(p.goal)}</p><p class="text-sm text-gray-500 mt-1"><strong>Backstory:</strong> ${sanitizeHTML(p.backstory)}</p>`;
                    personaContainer.appendChild(card);
                });
                return personaData.personas;
            } catch (error) {
                hideLoader(previewAgentLoader);
                personaContainer.innerHTML = `<p class="text-red-500 text-center col-span-full">Error: Could not assemble the agent team.</p>`;
                return null;
            }
        }


        async function duckDuckGoSearch(query) {
            const proxyUrl = 'https://corsproxy.io/?url=';
            const searchUrl = `https://html.duckduckgo.com/html/?q=${encodeURIComponent(query)}`;

            try {
                const response = await fetch(proxyUrl + searchUrl);
                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.statusText}`);
                }
                const htmlText = await response.text();

                // Use DOMParser to turn the HTML string into a document we can query.
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlText, 'text/html');

                // Extract snippets from the search results.
                const snippets = [];
                const snippetNodes = doc.querySelectorAll('.result__snippet');

                snippetNodes.forEach(node => {
                    snippets.push(node.innerText.trim());
                });

                if (snippets.length === 0) {
                    return "No search results found from DuckDuckGo. The page structure may have changed or the topic is very obscure.";
                }

                // Return the snippets joined as a single string.
                return snippets.join('\n\n');
            } catch (error) {
                console.error('DuckDuckGo search failed:', error);
                return `Failed to retrieve search results. Error: ${error.message}`;
            }
        }


        async function runRagAgent(topic) {
            stageRagContainer.classList.remove('hidden');
            showLoader(ragLoader, 'Research Agent is performing a web search via DuckDuckGo...');
            ragSummaryContainer.innerHTML = '';

            try {
                // 1. & 2. Perform web search with our custom DuckDuckGo function.
                const searchResults = await duckDuckGoSearch(topic);

                if (searchResults.startsWith('Failed') || searchResults.startsWith('No search')) {
                    throw new Error(searchResults);
                }

                ragLoaderText.textContent = 'Web search complete. Summarizing results...';

                // 3. Create the prompt for summarization with the retrieved results.
                const summarizerPromptText = prompts.rag_summary.replace('{search_results}', searchResults);

                // 4. Call Gemini to summarize the search results.
                const response = await callGemini([{ role: "user", parts: [{ text: summarizerPromptText }] }]);
                const summaryText = response.candidates[0].content.parts[0].text;

                // 5. Display summary and return it for the next stage.
                ragSummaryContainer.innerHTML = marked.parse(summaryText);
                hideLoader(ragLoader);
                return summaryText;

            } catch (error) {
                console.error("Error in runRagAgent:", error);
                hideLoader(ragLoader);
                ragSummaryContainer.innerHTML = `<p class="text-red-500">Error during RAG process: ${error.message}</p>`;
                return "Could not generate a summary.";
            }
        }


        async function runDivergentIdeation(topic, personas, ragSummary) {
            showLoader(divergentLoader);
            ideasContainer.innerHTML = '';
            allParsedIdeas = [];
            const RATE_LIMIT_DELAY = 1000;

            let ideaCounter = 0;
            const ideaPattern = /^\s*[\*\-]\s*(.*)/gm;

            for (const persona of personas) {
                const prompt = prompts.ideation[brainstormType]
                    .replace('{role}', persona.role)
                    .replace('{backstory}', persona.backstory)
                    .replace('{goal}', persona.goal)
                    .replace('{topic}', sanitizeHTML(topic))
                    .replace('{rag_summary}', ragSummary);

                try {
                    const response = await callGemini([{ role: "user", parts: [{ text: prompt }] }]);
                    const ideasText = response.candidates[0].content.parts[0].text;

                    const personaIdeasContainer = document.createElement('div');
                    personaIdeasContainer.className = 'agent-card bg-white p-4 rounded-lg border';
                    personaIdeasContainer.innerHTML = `<h3 class="font-bold text-blue-600 mb-2">${sanitizeHTML(persona.role)}</h3>`;

                    let match;
                    while ((match = ideaPattern.exec(ideasText)) !== null) {
                        const ideaText = match[1].trim();
                        const ideaId = `idea-${ideaCounter++}`;
                        allParsedIdeas.push({ role: persona.role, idea: ideaText, id: ideaId });

                        const checkboxContainer = document.createElement('div');
                        checkboxContainer.className = 'flex items-start gap-2 p-2 rounded-md hover:bg-gray-50';
                        checkboxContainer.innerHTML = `
                            <input type="checkbox" id="${ideaId}" data-role="${sanitizeHTML(persona.role)}" data-idea="${sanitizeHTML(ideaText)}" checked class="mt-1 h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <label for="${ideaId}" class="text-gray-700">${sanitizeHTML(ideaText)}</label>
                        `;
                        personaIdeasContainer.appendChild(checkboxContainer);
                    }
                    ideasContainer.appendChild(personaIdeasContainer);

                } catch (error) {
                    const errorCard = document.createElement('div');
                    errorCard.className = 'agent-card bg-white p-4 rounded-lg border';
                    errorCard.innerHTML = `<h3 class="font-bold text-blue-600 mb-2">${sanitizeHTML(persona.role)}</h3><p class="text-red-500 p-2 text-center">Error generating ideas.</p>`;
                    ideasContainer.appendChild(errorCard);
                }
                await new Promise(resolve => setTimeout(resolve, RATE_LIMIT_DELAY));
            }

            hideLoader(divergentLoader);
            if (allParsedIdeas.length > 0) {
                toConvergentBtn.classList.remove('hidden');
            }
        }

        toConvergentBtn.addEventListener('click', () => {
            const selectedIdeas = [];
            const checkboxes = ideasContainer.querySelectorAll('input[type="checkbox"]:checked');

            checkboxes.forEach(cb => {
                selectedIdeas.push({
                    role: cb.dataset.role,
                    idea: cb.dataset.idea
                });
            });

            if (selectedIdeas.length === 0) {
                alert("Please select at least one idea to proceed.");
                return;
            }

            const ideasByRole = selectedIdeas.reduce((acc, current) => {
                acc[current.role] = acc[current.role] || [];
                acc[current.role].push(`- ${current.idea}`);
                return acc;
            }, {});

            const ideasForEvaluation = Object.keys(ideasByRole).map(role => ({
                role: role,
                ideas: ideasByRole[role].join('\n')
            }));

            stage3Container.classList.remove('hidden');
            window.scrollTo({ top: stage3Container.offsetTop, behavior: 'smooth' });
            toConvergentBtn.classList.add('hidden');
            runConvergentEvaluation(ideasForEvaluation);
        });

        async function runConvergentEvaluation(ideas) {
            showLoader(convergentLoader);
            evaluationContainer.innerHTML = '';
            topIdeasContainer.innerHTML = '';

            const rawIdeasString = ideas.map(item => `Ideas from ${item.role}:\n${item.ideas}`).join('\n\n---\n\n');
            const prompt = prompts.evaluation[brainstormType].replace('{raw_ideas}', rawIdeasString);

            try {
                const response = await callGemini([{ role: "user", parts: [{ text: prompt }] }]);
                const evaluationText = response.candidates[0].content.parts[0].text;
                const jsonMatch = evaluationText.match(/```json\s*([\s\S]*?)\s*```/);
                let topIdeas = [];
                let evaluationMarkdown = evaluationText;

                if (jsonMatch && jsonMatch[1]) {
                    try {
                        topIdeas = JSON.parse(jsonMatch[1]);
                        evaluationMarkdown = evaluationText.replace(jsonMatch[0], '').trim();
                    } catch (e) {
                        console.error("Failed to parse top ideas JSON:", e);
                    }
                }

                evaluationContainer.innerHTML = marked.parse(evaluationMarkdown);

                if (topIdeas.length > 0) {
                    const header = document.createElement('h3');
                    header.className = 'text-xl font-semibold text-gray-700 stage-title';
                    header.textContent = 'Select a Top Idea to Plan';
                    topIdeasContainer.appendChild(header);
                    const listContainer = document.createElement('div');
                    listContainer.className = 'flex flex-col sm:flex-row gap-4 mt-4';
                    topIdeas.forEach(idea => {
                        const planBtn = document.createElement('button');
                        planBtn.className = 'bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700 transition-all duration-200 text-left';
                        planBtn.innerHTML = `<span class="font-bold">Plan:</span> ${sanitizeHTML(idea.title)}`;
                        planBtn.onclick = () => runImplementationPlanning(idea);
                        listContainer.appendChild(planBtn);
                    });
                    topIdeasContainer.appendChild(listContainer);
                }

            } catch (error) {
                evaluationContainer.innerHTML = `<p class="text-red-500">Error during evaluation: ${error.message}</p>`;
            } finally {
                hideLoader(convergentLoader);
            }
        }

        async function runImplementationPlanning(idea) {
            stage5Container.classList.remove('hidden');
            stage5Subtitle.textContent = `The AI expert has generated a high-level ${brainstormType === 'project' ? 'implementation plan' : 'research outline'} for the selected idea.`;

            window.scrollTo({ top: stage5Container.offsetTop, behavior: 'smooth' });
            showLoader(planningLoader);
            planningContainer.innerHTML = '';
            chartZoomLevel = 1.0; // Reset zoom level for new chart

            const prompt = prompts.planning[brainstormType]
                .replace('{title}', sanitizeHTML(idea.title))
                .replace('{description}', sanitizeHTML(idea.description));

            try {
                const response = await callGemini([{ role: "user", parts: [{ text: prompt }] }]);
                let planText = response.candidates[0].content.parts[0].text;

                const mermaidRegex = /```mermaid\s*([\s\S]*?)```/;
                const mermaidMatch = planText.match(mermaidRegex);

                const markdownContent = planText.replace(mermaidRegex, '').replace(/^```markdown\s*|```\s*$/g, '').trim();
                planningContainer.innerHTML = marked.parse(markdownContent);

                if (mermaidMatch && mermaidMatch[1]) {
                    const mermaidCode = mermaidMatch[1].trim();

                    const chartWrapper = document.createElement('div');
                    chartWrapper.className = 'mt-6';

                    const controlsHTML = `
                        <div id="chart-controls">
                            <button id="zoom-in-btn" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-1 px-3 rounded-lg">Zoom In</button>
                            <button id="zoom-out-btn" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-1 px-3 rounded-lg">Zoom Out</button>
                            <button id="reset-zoom-btn" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-1 px-3 rounded-lg">Reset</button>
                            <button id="fullscreen-btn" class="text-sm bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1 px-3 rounded-lg ml-auto">Fullscreen</button>
                        </div>
                    `;
                    chartWrapper.innerHTML = controlsHTML;

                    const chartContainer = document.createElement('div');
                    chartContainer.id = 'chart-container';
                    const mermaidDiv = document.createElement('div');
                    mermaidDiv.className = 'mermaid';
                    chartContainer.appendChild(mermaidDiv);
                    chartWrapper.appendChild(chartContainer);
                    planningContainer.appendChild(chartWrapper);

                    try {
                        const { svg } = await mermaid.render(`mermaid-diag-${Date.now()}`, mermaidCode);
                        mermaidDiv.innerHTML = svg;
                        const svgElement = mermaidDiv.querySelector('svg');

                        // Attach event listeners to controls
                        const zoomInBtn = chartWrapper.querySelector('#zoom-in-btn');
                        const zoomOutBtn = chartWrapper.querySelector('#zoom-out-btn');
                        const resetZoomBtn = chartWrapper.querySelector('#reset-zoom-btn');
                        const fullscreenBtn = chartWrapper.querySelector('#fullscreen-btn');

                        const updateZoom = () => {
                            svgElement.style.transform = `scale(${chartZoomLevel})`;
                        };

                        zoomInBtn.onclick = () => {
                            chartZoomLevel += 0.1;
                            updateZoom();
                        };
                        zoomOutBtn.onclick = () => {
                            chartZoomLevel = Math.max(0.1, chartZoomLevel - 0.1);
                            updateZoom();
                        };
                        resetZoomBtn.onclick = () => {
                            chartZoomLevel = 1.0;
                            updateZoom();
                        };
                        fullscreenBtn.onclick = () => {
                            fullscreenModalContent.innerHTML = ''; // Clear previous
                            const clonedSvg = svgElement.cloneNode(true);
                            clonedSvg.style.transform = ''; // Reset transform for modal
                            clonedSvg.style.maxWidth = '95vw';
                            clonedSvg.style.maxHeight = '95vh';
                            fullscreenModalContent.appendChild(clonedSvg);
                            fullscreenModal.classList.remove('hidden');
                            fullscreenModal.classList.add('flex'); // Make it a flex container
                            document.body.style.overflow = 'hidden'; // Prevent background scroll
                        };

                    } catch (e) {
                        console.error("Mermaid rendering failed:", e);
                        mermaidDiv.innerHTML = `<p class="text-red-500 font-bold">Mermaid Chart Error:</p><pre class="text-sm text-red-500 bg-red-50 p-2 rounded">${e.message}</pre><p class="mt-2 font-bold">Chart Code:</p><pre class="text-sm bg-gray-100 p-2 rounded">${sanitizeHTML(mermaidCode)}</pre>`;
                    }
                }
            } catch (error) {
                planningContainer.innerHTML = `<p class="text-red-500">Error generating the final document: ${error.message}</p>`;
            } finally {
                hideLoader(planningLoader);
            }
        }

        // Fullscreen modal close logic
        closeFullscreenBtn.addEventListener('click', () => {
            fullscreenModal.classList.add('hidden');
            fullscreenModal.classList.remove('flex'); // Remove flex display
            fullscreenModalContent.innerHTML = '';
            document.body.style.overflow = 'auto';
        });

    </script>
</body>

</html>